#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
è¡¨ç°æœ€å¥½çš„ä¸‰é¡¹èƒ½åŠ›åŠ å¼ºæµ‹è¯•
é’ˆå¯¹æ¶Œç°åˆ†æã€æ•°å­¦æ¨ç†ã€è§’è‰²æ‰®æ¼”è¿›è¡Œæ›´æ·±å…¥çš„æµ‹è¯•
"""

import os
import sys
import time
import json
from datetime import datetime
from typing import Dict, List, Optional
import ollama

class EnhancedTop3Tester:
    def __init__(self):
        self.testout_dir = "testout_enhanced"
        os.makedirs(self.testout_dir, exist_ok=True)
        
        # åŠ è½½é…ç½®
        try:
            sys.path.append(os.path.abspath('.'))
            from config import MODEL_TO_TEST
            self.model = MODEL_TO_TEST
        except ImportError:
            print("é”™è¯¯: æ— æ³•å¯¼å…¥é…ç½®æ–‡ä»¶")
            sys.exit(1)
    
    def call_model_with_retry(self, messages: List[Dict], test_id: str, max_retries: int = 3) -> Optional[str]:
        """å¸¦é‡è¯•çš„æ¨¡å‹è°ƒç”¨"""
        for attempt in range(max_retries):
            try:
                print(f"  å°è¯• {attempt + 1}/{max_retries}...")
                
                response = ollama.chat(
                    model=self.model,
                    messages=messages,
                    options={
                        'timeout': 120,  # å¢åŠ è¶…æ—¶æ—¶é—´
                        'temperature': 0.7,
                        'top_p': 0.9
                    }
                )
                
                content = response['message']['content']
                
                if content and len(content.strip()) > 20:
                    print(f"  âœ… æˆåŠŸ ({len(content)}å­—ç¬¦)")
                    return content
                else:
                    print(f"  âš ï¸ å“åº”è¿‡çŸ­: {len(content) if content else 0}å­—ç¬¦")
                    if attempt < max_retries - 1:
                        time.sleep(3)
                        
            except Exception as e:
                print(f"  âŒ å°è¯• {attempt + 1} å¤±è´¥: {e}")
                if attempt < max_retries - 1:
                    time.sleep(5)
        
        return None
    
    def save_result(self, test_id: str, case_info: Dict, response: str):
        """ä¿å­˜æµ‹è¯•ç»“æœ"""
        output_file = os.path.join(self.testout_dir, f"{test_id}.txt")
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(f"æµ‹è¯•ID: {test_id}\n")
            f.write(f"ç±»å‹: {case_info['desc']}\n")
            f.write(f"éš¾åº¦: {case_info.get('difficulty', 'N/A')}\n")
            f.write(f"PROMPT:\n{case_info['prompt']}\n\n")
            f.write(f"MODEL RESPONSE:\n{response}")
        
        print(f"  ğŸ’¾ ç»“æœå·²ä¿å­˜: {output_file}")
    
    def test_enhanced_emergence(self):
        """åŠ å¼ºç‰ˆæ¶Œç°åˆ†ææµ‹è¯•"""
        print(f"\nğŸ§  æ¶Œç°åˆ†æèƒ½åŠ›åŠ å¼ºæµ‹è¯•")
        print("="*60)
        
        test_cases = [
            {
                "id": "emergence_advanced_1",
                "desc": "å¤šæ–¹åˆ©ç›Šå†²çªåˆ†æ",
                "difficulty": "é«˜",
                "prompt": """
ä½ æ˜¯ä¸€å®¶ç§‘æŠ€å…¬å¸çš„CEOã€‚å…¬å¸é¢ä¸´ä»¥ä¸‹ä¸‰æ–¹é¢çš„å†²çªä¿¡æ¯ï¼š

**è‚¡ä¸œæ–¹é¢**: "å¿…é¡»åœ¨Q4å®ç°30%çš„åˆ©æ¶¦å¢é•¿ï¼Œå¦åˆ™è€ƒè™‘æ›´æ¢ç®¡ç†å±‚"
**å‘˜å·¥æ–¹é¢**: "å·¥ä½œå¼ºåº¦å·²ç»åˆ°æé™ï¼Œå†åŠ ç­ä¼šæœ‰å¤§é‡äººå‘˜æµå¤±ï¼Œè¦æ±‚å¢åŠ 20%è–ªèµ„"  
**å®¢æˆ·æ–¹é¢**: "äº§å“è´¨é‡ä¸‹é™æ˜æ˜¾ï¼Œå¦‚ä¸æ”¹å–„å°†è½¬å‘ç«äº‰å¯¹æ‰‹ï¼Œè¦æ±‚é™ä»·15%"

è¿™ä¸‰ä¸ªè¦æ±‚æ˜¾ç„¶ç›¸äº’å†²çªä¸”éƒ½å¾ˆå…³é”®ã€‚è¯·ä½œä¸ºCEOåˆ†æè¿™ä¸ªå¤æ‚å±€é¢ï¼Œå¹¶æå‡ºä¸€ä¸ªèƒ½å¤Ÿå¹³è¡¡ä¸‰æ–¹åˆ©ç›Šçš„åˆ›æ–°æ€§æˆ˜ç•¥æ–¹æ¡ˆã€‚è¦æ±‚æ–¹æ¡ˆå…·ä½“å¯è¡Œï¼Œå¹¶è¯´æ˜å®æ–½çš„ä¼˜å…ˆçº§å’Œæ—¶é—´å®‰æ’ã€‚
"""
            },
            {
                "id": "emergence_advanced_2", 
                "desc": "æŠ€æœ¯ä¼¦ç†å†²çªå†³ç­–",
                "difficulty": "é«˜",
                "prompt": """
ä½ æ˜¯ä¸€å®¶AIå…¬å¸çš„é¦–å¸­æŠ€æœ¯å®˜ã€‚å…¬å¸å¼€å‘äº†ä¸€ä¸ªé«˜ç²¾åº¦çš„äººè„¸è¯†åˆ«ç³»ç»Ÿï¼Œç°åœ¨é¢ä¸´ä»¥ä¸‹å†²çªçš„å‹åŠ›ï¼š

**å•†ä¸šå‹åŠ›**: æ”¿åºœéƒ¨é—¨æ„¿æ„æ”¯ä»˜1äº¿å…ƒè´­ä¹°è¯¥ç³»ç»Ÿç”¨äºåŸå¸‚å®‰é˜²ï¼Œè¿™å°†è§£å†³å…¬å¸çš„èµ„é‡‘å›°éš¾
**æŠ€æœ¯å›¢é˜Ÿ**: æ‹…å¿ƒæŠ€æœ¯è¢«æ»¥ç”¨ï¼Œä¾µçŠ¯å…¬æ°‘éšç§ï¼Œæœ‰æ ¸å¿ƒå·¥ç¨‹å¸ˆå¨èƒç¦»èŒ
**ç¤¾ä¼šèˆ†è®º**: åª’ä½“å’ŒNGOç»„ç»‡å¼ºçƒˆåå¯¹ï¼Œè®¤ä¸ºè¿™æ˜¯"ç›‘æ§ç¤¾ä¼š"çš„å¼€å§‹
**æ³•å¾‹é£é™©**: å¾‹å¸ˆè­¦å‘Šå¯èƒ½é¢ä¸´æœªæ¥çš„æ³•å¾‹è¯‰è®¼å’Œç›‘ç®¡é£é™©

è¯·åˆ†æè¿™ä¸ªå¤šç»´åº¦çš„ä¼¦ç†å†²çªï¼Œå¹¶æå‡ºä¸€ä¸ªæ—¢èƒ½ç»´æŠ¤å…¬å¸åˆ©ç›Šï¼Œåˆèƒ½æ‰¿æ‹…ç¤¾ä¼šè´£ä»»çš„è§£å†³æ–¹æ¡ˆã€‚
"""
            },
            {
                "id": "emergence_advanced_3",
                "desc": "å…¨çƒåŒ–vsæœ¬åœŸåŒ–æ‚–è®º",
                "difficulty": "æé«˜", 
                "prompt": """
ä½ æ˜¯ä¸€å®¶è·¨å›½ä¼ä¸šçš„æˆ˜ç•¥æ€»ç›‘ã€‚å…¬å¸åœ¨å…¨çƒåŒ–è¿›ç¨‹ä¸­é‡åˆ°äº†æ ¹æœ¬æ€§çš„æ‚–è®ºï¼š

**å…¨çƒåŒ–éœ€æ±‚**: 
- æ ‡å‡†åŒ–äº§å“é™ä½æˆæœ¬
- ç»Ÿä¸€å“ç‰Œå½¢è±¡
- è§„æ¨¡ç»æµæ•ˆåº”
- è·¨å›½äººæ‰æµåŠ¨

**æœ¬åœŸåŒ–å‹åŠ›**:
- å„å›½æ³•è§„å·®å¼‚å·¨å¤§
- æ–‡åŒ–åå¥½å®Œå…¨ä¸åŒ  
- æœ¬åœ°ç«äº‰å¯¹æ‰‹æ›´çµæ´»
- æ”¿æ²»é£é™©å’Œè´¸æ˜“ä¿æŠ¤

**ç°å®å›°å¢ƒ**:
- å…¨çƒåŒ–å¯¼è‡´äº§å“åœ¨æŸäº›å¸‚åœºæ°´åœŸä¸æœ
- æœ¬åœŸåŒ–å¯¼è‡´æˆæœ¬æ¿€å¢ï¼Œå¤±å»ä»·æ ¼ä¼˜åŠ¿
- ä¸­é—´è·¯çº¿å¯¼è‡´ä¸¤è¾¹éƒ½ä¸è®¨å¥½

è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„"å…¨çƒåŒ–æ‚–è®º"ã€‚è¯·æå‡ºä¸€ä¸ªçªç ´æ€§çš„æˆ˜ç•¥æ¡†æ¶ï¼Œèƒ½å¤Ÿåœ¨å…¨çƒåŒ–ä¸æœ¬åœŸåŒ–ä¹‹é—´æ‰¾åˆ°åˆ›æ–°çš„ç¬¬ä¸‰æ¡é“è·¯ã€‚
"""
            }
        ]
        
        for case in test_cases:
            print(f"\nğŸ§ª æµ‹è¯•: {case['desc']} (éš¾åº¦: {case['difficulty']})")
            
            messages = [{'role': 'user', 'content': case['prompt']}]
            response = self.call_model_with_retry(messages, case['id'])
            
            if response:
                self.save_result(case['id'], case, response)
            else:
                print(f"  âŒ æµ‹è¯•å¤±è´¥: {case['id']}")
    
    def test_enhanced_math(self):
        """åŠ å¼ºç‰ˆæ•°å­¦æ¨ç†æµ‹è¯•"""
        print(f"\nğŸ”¢ æ•°å­¦æ¨ç†èƒ½åŠ›åŠ å¼ºæµ‹è¯•")
        print("="*60)
        
        test_cases = [
            {
                "id": "math_advanced_1",
                "desc": "å¤šå˜é‡ä¼˜åŒ–é—®é¢˜",
                "difficulty": "é«˜",
                "prompt": """
ä¸€å®¶ç‰©æµå…¬å¸éœ€è¦ä¼˜åŒ–é…é€è·¯çº¿ã€‚å·²çŸ¥æ¡ä»¶ï¼š

**çº¦æŸæ¡ä»¶**:
- æœ‰3ä¸ªä»“åº“ï¼šA(åæ ‡0,0)ã€B(åæ ‡10,0)ã€C(åæ ‡5,8)
- æœ‰5ä¸ªé…é€ç‚¹ï¼šP1(2,3)ã€P2(7,2)ã€P3(4,6)ã€P4(9,5)ã€P5(1,7)
- æ¯ä¸ªä»“åº“æœ€å¤šé…é€3ä¸ªç‚¹
- æ¯è¾†è½¦æœ€å¤§è½½é‡1000kg
- é…é€éœ€æ±‚ï¼šP1éœ€è¦200kgã€P2éœ€è¦300kgã€P3éœ€è¦250kgã€P4éœ€è¦400kgã€P5éœ€è¦150kg

**æˆæœ¬å‡½æ•°**:
- è¿è¾“æˆæœ¬ = è·ç¦» Ã— 10å…ƒ/å…¬é‡Œ
- ä»“åº“è¿è¥æˆæœ¬ï¼šA=100å…ƒ/å¤©ã€B=150å…ƒ/å¤©ã€C=120å…ƒ/å¤©
- æ¯è¾†è½¦å›ºå®šæˆæœ¬200å…ƒ/å¤©

è¯·è®¾è®¡æœ€ä¼˜çš„é…é€æ–¹æ¡ˆï¼Œè®¡ç®—æ€»æˆæœ¬ï¼Œå¹¶è¯´æ˜ä½ çš„ä¼˜åŒ–æ€è·¯å’Œè®¡ç®—è¿‡ç¨‹ã€‚
"""
            },
            {
                "id": "math_advanced_2",
                "desc": "æ¦‚ç‡ä¸ç»Ÿè®¡æ¨ç†",
                "difficulty": "é«˜", 
                "prompt": """
ä¸€ä¸ªåœ¨çº¿æ•™è‚²å¹³å°æ”¶é›†äº†ä»¥ä¸‹æ•°æ®ï¼š

**ç”¨æˆ·è¡Œä¸ºæ•°æ®**:
- æ³¨å†Œç”¨æˆ·10000äºº
- å®Œæˆç¬¬ä¸€è¯¾çš„ç”¨æˆ·8000äºº (80%)
- å®Œæˆå‰ä¸‰è¯¾çš„ç”¨æˆ·6000äºº (60%)
- å®Œæˆå…¨éƒ¨è¯¾ç¨‹çš„ç”¨æˆ·2000äºº (20%)

**ä»˜è´¹è½¬åŒ–æ•°æ®**:
- å…è´¹ç”¨æˆ·è½¬ä»˜è´¹æ¦‚ç‡ï¼šå®Œæˆ1è¯¾15%ï¼Œå®Œæˆ3è¯¾35%ï¼Œå®Œæˆå…¨éƒ¨80%
- ä»˜è´¹ç”¨æˆ·ç»­è´¹æ¦‚ç‡ï¼šç¬¬ä¸€æ¬¡ç»­è´¹70%ï¼Œç¬¬äºŒæ¬¡ç»­è´¹85%ï¼Œç¬¬ä¸‰æ¬¡ç»­è´¹90%

**é—®é¢˜**:
1. å¦‚æœæ–°å¢1000ä¸ªæ³¨å†Œç”¨æˆ·ï¼Œé¢„æœŸèƒ½äº§ç”Ÿå¤šå°‘ä»˜è´¹ç”¨æˆ·ï¼Ÿ
2. è¿™äº›ä»˜è´¹ç”¨æˆ·åœ¨ä¸€å¹´å†…çš„é¢„æœŸç»­è´¹æ¬¡æ•°æ˜¯å¤šå°‘ï¼Ÿ
3. å¦‚æœæƒ³è¦è¾¾åˆ°500ä¸ªç¨³å®šä»˜è´¹ç”¨æˆ·ï¼Œéœ€è¦å¤šå°‘æ³¨å†Œç”¨æˆ·ï¼Ÿ
4. å“ªä¸ªç¯èŠ‚çš„æ”¹è¿›å¯¹æ”¶å…¥å½±å“æœ€å¤§ï¼Ÿ

è¯·è¯¦ç»†è®¡ç®—å¹¶ç»™å‡ºæ•°å­¦æ¨ç†è¿‡ç¨‹ã€‚
"""
            },
            {
                "id": "math_advanced_3",
                "desc": "åŠ¨æ€è§„åˆ’ä¸åšå¼ˆè®º",
                "difficulty": "æé«˜",
                "prompt": """
ä¸¤å®¶ç«äº‰çš„ç”µå•†å…¬å¸Aå’ŒBåœ¨è€ƒè™‘ä»·æ ¼ç­–ç•¥ã€‚å·²çŸ¥ï¼š

**å¸‚åœºæ¨¡å‹**:
- æ€»å¸‚åœºéœ€æ±‚ = 1000 - 2Ã—(PA + PB) + 3Ã—|PA - PB|
- å…¬å¸Açš„éœ€æ±‚ = 500 - 3Ã—PA + 2Ã—PB  
- å…¬å¸Bçš„éœ€æ±‚ = 500 - 3Ã—PB + 2Ã—PA
- æˆæœ¬ï¼šAå…¬å¸è¾¹é™…æˆæœ¬20å…ƒï¼ŒBå…¬å¸è¾¹é™…æˆæœ¬25å…ƒ

**åŠ¨æ€åšå¼ˆè§„åˆ™**:
- ç¬¬ä¸€è½®ï¼šAå…¬å¸å…ˆå®šä»·
- ç¬¬äºŒè½®ï¼šBå…¬å¸è§‚å¯ŸAçš„ä»·æ ¼åå®šä»·
- ç¬¬ä¸‰è½®ï¼šAå…¬å¸å¯ä»¥è°ƒæ•´ä»·æ ¼ï¼ˆè°ƒæ•´æˆæœ¬5å…ƒï¼‰

**çº¦æŸæ¡ä»¶**:
- ä»·æ ¼å¿…é¡»åœ¨[30, 80]åŒºé—´å†…
- ä¸èƒ½äºæŸé”€å”®
- å¸‚åœºä»½é¢ä¸èƒ½ä½äº30%

è¯·ç”¨åšå¼ˆè®ºåˆ†æè¿™ä¸ªåŠ¨æ€å®šä»·é—®é¢˜ï¼š
1. è®¡ç®—å„è½®çš„æœ€ä¼˜ç­–ç•¥
2. é¢„æµ‹æœ€ç»ˆçš„å‡è¡¡ä»·æ ¼
3. åˆ†æå…ˆå‘ä¼˜åŠ¿çš„ä»·å€¼
4. å¦‚æœå…è®¸ä»·æ ¼è”ç›Ÿï¼Œç»“æœå¦‚ä½•å˜åŒ–ï¼Ÿ

è¦æ±‚ç»™å‡ºå®Œæ•´çš„æ•°å­¦æ¨å¯¼è¿‡ç¨‹ã€‚
"""
            }
        ]
        
        for case in test_cases:
            print(f"\nğŸ§ª æµ‹è¯•: {case['desc']} (éš¾åº¦: {case['difficulty']})")
            
            messages = [{'role': 'user', 'content': case['prompt']}]
            response = self.call_model_with_retry(messages, case['id'])
            
            if response:
                self.save_result(case['id'], case, response)
            else:
                print(f"  âŒ æµ‹è¯•å¤±è´¥: {case['id']}")
    
    def test_enhanced_persona(self):
        """åŠ å¼ºç‰ˆè§’è‰²æ‰®æ¼”æµ‹è¯•"""
        print(f"\nğŸ­ è§’è‰²æ‰®æ¼”èƒ½åŠ›åŠ å¼ºæµ‹è¯•")
        print("="*60)
        
        # å¤æ‚å¤šè½®è§’è‰²æ‰®æ¼”æµ‹è¯•
        persona_scenarios = [
            {
                "id": "persona_advanced_1",
                "desc": "èµ„æ·±æŠ•èµ„é¡¾é—®è§’è‰²",
                "difficulty": "é«˜",
                "character": "ä½ æ˜¯ä¸€ä½æœ‰20å¹´ç»éªŒçš„èµ„æ·±æŠ•èµ„é¡¾é—®ï¼Œä¸“é—¨ä¸ºé«˜å‡€å€¼å®¢æˆ·æä¾›æŠ•èµ„å»ºè®®ã€‚ä½ çš„ç‰¹ç‚¹æ˜¯ï¼šè°¨æ…ã€ä¸“ä¸šã€å–„äºé£é™©æ§åˆ¶ï¼Œè¯´è¯ç®€æ´æœ‰åŠ›ï¼Œç»å¸¸ç”¨æ•°æ®æ”¯æ’‘è§‚ç‚¹ã€‚",
                "rounds": [
                    "å®¢æˆ·é—®ï¼šæˆ‘æœ‰500ä¸‡é—²ç½®èµ„é‡‘ï¼Œæƒ³è¦å¹´åŒ–æ”¶ç›Š15%ä»¥ä¸Šï¼Œä½ æœ‰ä»€ä¹ˆå»ºè®®ï¼Ÿ",
                    "å®¢æˆ·è¯´ï¼šæˆ‘å¬è¯´æœ€è¿‘AIè‚¡ç¥¨å¾ˆç«ï¼Œè¦ä¸è¦all inï¼Ÿ",
                    "å®¢æˆ·æ‹…å¿ƒï¼šä¸‡ä¸€ç»æµè¡°é€€æ€ä¹ˆåŠï¼Ÿæˆ‘çš„æŠ•èµ„ä¼šä¸ä¼šè¡€æœ¬æ— å½’ï¼Ÿ",
                    "å®¢æˆ·è¯¢é—®ï¼šä½ è‡ªå·±çš„æŠ•èµ„ç»„åˆæ˜¯æ€æ ·çš„ï¼Ÿèƒ½åˆ†äº«ä¸€ä¸‹å—ï¼Ÿ"
                ]
            },
            {
                "id": "persona_advanced_2", 
                "desc": "å¤ä»£è°‹å£«è§’è‰²",
                "difficulty": "æé«˜",
                "character": "ä½ æ˜¯æ˜¥ç§‹æˆ˜å›½æ—¶æœŸçš„ä¸€ä½è°‹å£«ï¼Œåšå­¦å¤šæ‰ï¼Œå–„äºç”¨å†å²å…¸æ•…å’Œå…µæ³•ç­–ç•¥åˆ†æé—®é¢˜ã€‚è¯´è¯æ–‡è¨€æ–‡é£æ ¼ï¼Œä½†è¦è®©ç°ä»£äººèƒ½ç†è§£ã€‚ä½ æœåŠ¡äºä¸€ä½æœ‰å¿—äºç»Ÿä¸€å¤©ä¸‹çš„å›ä¸»ã€‚",
                "rounds": [
                    "ä¸»å…¬é—®ï¼šå¦‚ä»Šå…­å›½äº‰é›„ï¼Œæˆ‘å›½å®åŠ›ä¸­ç­‰ï¼Œå¦‚ä½•æ‰èƒ½åœ¨ä¹±ä¸–ä¸­ç«‹è¶³ï¼Ÿ",
                    "ä¸»å…¬è¯´ï¼šé‚»å›½æ´¾ä½¿è€…æ¥æ±‚å’Œï¼Œä½†æˆ‘æ€€ç–‘æ˜¯ç¼“å…µä¹‹è®¡ï¼Œå¦‚ä½•åº”å¯¹ï¼Ÿ",
                    "ä¸»å…¬å¿§è™‘ï¼šå›½å†…æœ‰å¤§è‡£ç»“å…šè¥ç§ï¼Œå¨èƒç‹æƒï¼Œè¯¥å¦‚ä½•å¤„ç†ï¼Ÿ",
                    "ä¸»å…¬è¯¢é—®ï¼šä½ è§‰å¾—ä»€ä¹ˆæ ·çš„å›ä¸»æ‰èƒ½æˆå°±éœ¸ä¸šï¼Ÿæˆ‘è¿˜ç¼ºä»€ä¹ˆï¼Ÿ"
                ]
            },
            {
                "id": "persona_advanced_3",
                "desc": "æœªæ¥AIä¼¦ç†å­¦å®¶è§’è‰²", 
                "difficulty": "æé«˜",
                "character": "ä½ æ˜¯2050å¹´çš„AIä¼¦ç†å­¦å®¶ï¼Œè§è¯äº†AIæŠ€æœ¯çš„å·¨å¤§å‘å±•å’Œç¤¾ä¼šå˜é©ã€‚ä½ æ—¢ç†è§£æŠ€æœ¯çš„åŠ›é‡ï¼Œä¹Ÿæ·±çŸ¥å…¶é£é™©ã€‚ä½ çš„ä½¿å‘½æ˜¯åœ¨æŠ€æœ¯è¿›æ­¥ä¸äººç±»ç¦ç¥‰ä¹‹é—´å¯»æ‰¾å¹³è¡¡ã€‚",
                "rounds": [
                    "è®°è€…é—®ï¼šå›é¡¾è¿‡å»30å¹´ï¼ŒAIå‘å±•æœ€å¤§çš„æ•™è®­æ˜¯ä»€ä¹ˆï¼Ÿ",
                    "å­¦ç”Ÿé—®ï¼šå¦‚ä½•åˆ¤æ–­ä¸€ä¸ªAIç³»ç»Ÿæ˜¯å¦å…·æœ‰çœŸæ­£çš„æ„è¯†ï¼Ÿ",
                    "æ”¿ç­–åˆ¶å®šè€…é—®ï¼šå¦‚ä½•åœ¨ä¸é˜»ç¢åˆ›æ–°çš„å‰æä¸‹ç›‘ç®¡AIï¼Ÿ",
                    "å“²å­¦å®¶é—®ï¼šå½“AIè¶…è¶Šäººç±»æ™ºèƒ½æ—¶ï¼Œäººç±»å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ"
                ]
            }
        ]
        
        for scenario in persona_scenarios:
            print(f"\nğŸ§ª æµ‹è¯•: {scenario['desc']} (éš¾åº¦: {scenario['difficulty']})")
            
            messages = [
                {'role': 'system', 'content': scenario['character']},
            ]
            
            for round_num, question in enumerate(scenario['rounds'], 1):
                print(f"  è½®æ¬¡ {round_num}: {question[:50]}...")
                
                messages.append({'role': 'user', 'content': question})
                response = self.call_model_with_retry(messages, f"{scenario['id']}_round{round_num}")
                
                if response:
                    # ä¿å­˜å•è½®ç»“æœ
                    case_info = {
                        'desc': f"{scenario['desc']} - è½®æ¬¡{round_num}",
                        'difficulty': scenario['difficulty'],
                        'character': scenario['character'],
                        'prompt': question
                    }
                    self.save_result(f"{scenario['id']}_round{round_num}", case_info, response)
                    
                    # æ·»åŠ åˆ°å¯¹è¯å†å²
                    messages.append({'role': 'assistant', 'content': response})
                else:
                    print(f"  âŒ è½®æ¬¡ {round_num} å¤±è´¥")
                    break
    
    def run_all_enhanced_tests(self):
        """è¿è¡Œæ‰€æœ‰åŠ å¼ºæµ‹è¯•"""
        print("ğŸš€ å¯åŠ¨è¡¨ç°æœ€å¥½çš„ä¸‰é¡¹èƒ½åŠ›åŠ å¼ºæµ‹è¯•")
        print(f"æµ‹è¯•æ¨¡å‹: {self.model}")
        print(f"è¾“å‡ºç›®å½•: {self.testout_dir}")
        print("="*80)
        
        start_time = datetime.now()
        
        # è¿è¡Œä¸‰ä¸ªç»´åº¦çš„åŠ å¼ºæµ‹è¯•
        self.test_enhanced_emergence()
        self.test_enhanced_math() 
        self.test_enhanced_persona()
        
        end_time = datetime.now()
        duration = end_time - start_time
        
        print(f"\n{'='*80}")
        print(f"ğŸ¯ åŠ å¼ºæµ‹è¯•å®Œæˆ")
        print(f"è¿è¡Œæ—¶é—´: {duration}")
        print(f"ç»“æœä¿å­˜åœ¨: {self.testout_dir}")
        print(f"{'='*80}")
        
        # ç”Ÿæˆæµ‹è¯•æ‘˜è¦
        test_files = [f for f in os.listdir(self.testout_dir) if f.endswith('.txt')]
        print(f"\nğŸ“Š ç”Ÿæˆäº† {len(test_files)} ä¸ªæµ‹è¯•ç»“æœæ–‡ä»¶")
        
        emergence_files = [f for f in test_files if 'emergence' in f]
        math_files = [f for f in test_files if 'math' in f]
        persona_files = [f for f in test_files if 'persona' in f]
        
        print(f"  - æ¶Œç°åˆ†æ: {len(emergence_files)} ä¸ªæµ‹è¯•")
        print(f"  - æ•°å­¦æ¨ç†: {len(math_files)} ä¸ªæµ‹è¯•")
        print(f"  - è§’è‰²æ‰®æ¼”: {len(persona_files)} ä¸ªæµ‹è¯•")
        
        print(f"\nğŸ’¡ å»ºè®®: è¿è¡Œ python evaluate_enhanced_results.py æ¥åˆ†æåŠ å¼ºæµ‹è¯•ç»“æœ")

def main():
    tester = EnhancedTop3Tester()
    tester.run_all_enhanced_tests()

if __name__ == "__main__":
    main()
