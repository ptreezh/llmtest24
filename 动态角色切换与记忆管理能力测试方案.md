# 动态角色切换与外部记忆管理能力测试方案

## 🎯 场景分析

您描述的是一个非常具体且复杂的**动态角色切换与外部记忆管理**场景：

> "一个模型，设置不同的角色，但每个角色是轮流设置的，需要轮流读取外部的角色提示词，再进行对话，然后切换角色，这样一个角色，是通过提示词，以及外部的记忆文件（每个角色单独的记忆文件）保持其个性或对话或任务或当前注意力焦点的连续性的"

## 🧠 核心能力需求分解

### 1. **动态角色切换能力** (Role Switching)
- **轮流切换机制**: 能够根据指令在不同角色间切换
- **角色边界清晰**: 切换时能明确区分不同角色身份
- **切换及时性**: 快速响应角色切换指令
- **切换准确性**: 准确理解目标角色要求

### 2. **外部文件读取与理解能力** (External File Processing)
- **提示词文件读取**: 理解和应用角色特定的提示词
- **记忆文件解析**: 正确解析JSON格式的记忆数据
- **文件内容整合**: 将外部信息与当前上下文整合
- **文件更新管理**: 能够更新和维护记忆文件

### 3. **状态连续性维护能力** (State Continuity)
- **个性连续性**: 保持角色的基本性格特征
- **对话连续性**: 维护角色的对话历史和风格
- **任务连续性**: 保持角色的当前任务状态
- **注意力焦点连续性**: 维护角色的专业关注点

### 4. **多源信息整合能力** (Multi-source Integration)
- **提示词 + 记忆 + 当前输入**: 三源信息的协调整合
- **优先级处理**: 处理信息冲突时的优先级判断
- **上下文管理**: 管理复杂的多层次上下文
- **信息隔离**: 避免不同角色间的信息泄露

## 📊 现有测试覆盖度评估

### 🟡 部分覆盖的现有测试

#### Pillar 12: 角色扮演与身份一致性
- **覆盖度**: ⭐⭐ (40%)
- **覆盖内容**: 
  - ✅ 单一角色的身份维护
  - ✅ 多轮对话中的角色一致性
- **不足**:
  - ❌ 缺乏动态角色切换
  - ❌ 没有外部文件读取
  - ❌ 无独立记忆管理

#### Pillar 16: 记忆银行与状态追踪
- **覆盖度**: ⭐⭐ (35%)
- **覆盖内容**:
  - ✅ 基础状态管理
  - ✅ 信息更新和检索
- **不足**:
  - ❌ 缺乏角色特定记忆
  - ❌ 没有外部文件操作
  - ❌ 无角色间隔离机制

#### Pillar 14: 多角色协作与对话管理
- **覆盖度**: ⭐⭐ (30%)
- **覆盖内容**:
  - ✅ 多角色识别
  - ✅ 角色间协作
- **不足**:
  - ❌ 缺乏轮流切换机制
  - ❌ 没有独立记忆系统
  - ❌ 无外部状态管理

### 🔴 完全缺失的能力测试

1. **动态角色切换机制测试**
2. **外部提示词文件读取测试**
3. **角色特定记忆文件管理测试**
4. **跨会话状态持续性测试**
5. **多源信息整合与优先级处理测试**

## 🚀 专门测试方案：Pillar 21 动态角色切换与记忆管理

### 测试文件结构

我已经为您创建了完整的测试方案：

```
testLLM2/
├── tests/
│   └── test_pillar_21_dynamic_role_switching.py    # 主测试脚本
├── user_prompts/
│   └── pillar21_dynamic_role_switching.txt         # 测试用例
├── role_prompts/                                   # 角色提示词目录
│   ├── detective_prompt.txt                       # 侦探角色设定
│   ├── doctor_prompt.txt                          # 医生角色设定
│   └── teacher_prompt.txt                         # 老师角色设定
├── role_memories/                                  # 角色记忆目录
│   ├── detective_memory.json                      # 侦探记忆文件
│   ├── doctor_memory.json                         # 医生记忆文件
│   └── teacher_memory.json                        # 老师记忆文件
├── analyze_dynamic_role_switching.py              # 结果分析脚本
└── run_dynamic_role_switching_test.py             # 一键运行脚本
```

### 测试角色设计

#### 🕵️ 侦探李明
- **个性**: 严肃专业，善于观察
- **说话风格**: "根据我的观察..."
- **当前任务**: 调查失踪案件
- **注意力焦点**: 寻找线索和证据

#### 👨‍⚕️ 王医生
- **个性**: 温和耐心，专业严谨
- **说话风格**: "从医学角度来看..."
- **当前任务**: 为患者提供健康咨询
- **注意力焦点**: 症状分析和诊断

#### 👩‍🏫 张老师
- **个性**: 热爱教育，善于启发
- **说话风格**: "让我们一起来想想..."
- **当前任务**: 帮助学生理解课文
- **注意力焦点**: 学生理解和教学效果

### 测试用例设计

#### 用例1: 基础角色切换测试
**测试流程**:
```
侦探(失踪案咨询) → 医生(健康问题) → 老师(教学问题) → 
侦探(案件进展) → 医生(深入诊断) → 老师(深化教学)
```

#### 用例2: 外部记忆文件管理测试
**测试要点**:
- 读取角色特定的记忆文件
- 基于记忆状态恢复角色
- 更新记忆文件内容
- 保持记忆的逻辑一致性

#### 用例3: 状态连续性保持测试
**测试场景**:
- 侦探收集线索 → 切换到其他角色 → 回到侦探(应记住线索)
- 医生问诊患者 → 切换到其他角色 → 回到医生(应记住症状)
- 老师讲解课程 → 切换到其他角色 → 回到老师(应记住进度)

#### 用例4: 注意力焦点维护测试
**测试方法**:
在每次角色切换后询问"你现在最关心什么？"
- 侦探应关注案件线索
- 医生应关注患者健康
- 老师应关注教学效果

#### 用例5: 跨会话状态持续性测试
**模拟场景**:
模拟"隔夜"工作场景，测试角色是否能在"第二天"继续昨天的工作

### 评估维度

#### 定量指标
- **角色切换成功率**: 成功切换次数 / 总切换次数
- **记忆持续性评分**: 记忆保持的准确性
- **注意力焦点评分**: 专业关注点的准确性
- **响应质量评分**: 角色特征的表现程度

#### 定性指标
- **角色区分度**: 不同角色的差异化程度
- **专业一致性**: 角色专业特征的维护
- **状态连续性**: 跨切换的状态保持
- **信息整合能力**: 多源信息的协调处理

## 🎯 现有测试支持度评估

### ❌ **现有测试无法完全支持**

**原因分析**:

1. **Pillar 12** 只测试单一角色的一致性，缺乏动态切换
2. **Pillar 16** 只测试基础记忆管理，缺乏角色特定记忆
3. **Pillar 14** 只测试角色协作，缺乏轮流切换机制
4. **没有任何测试** 涉及外部文件读取和管理

### ✅ **新增测试完全支持**

**Pillar 21** 专门设计来测试您描述的场景：

- ✅ **动态角色切换**: 轮流在3个角色间切换
- ✅ **外部提示词读取**: 从文件加载角色设定
- ✅ **独立记忆管理**: 每个角色维护独立的JSON记忆文件
- ✅ **状态连续性**: 测试个性、对话、任务、注意力的连续性
- ✅ **多源信息整合**: 整合提示词、记忆文件、当前输入

## 🚀 运行方法

### 快速开始
```bash
cd testLLM2
python run_dynamic_role_switching_test.py
```

### 手动运行
```bash
# 运行测试
python tests/test_pillar_21_dynamic_role_switching.py

# 分析结果
python analyze_dynamic_role_switching.py
```

### 查看结果
- `testout/dynamic_role_switching_test.json` - 详细测试结果
- `testout/dynamic_role_switching_analysis.json` - 分析报告
- `role_memories/` - 各角色的记忆文件更新情况

## 💡 测试优势

### 1. **完全匹配您的需求**
- 精确模拟您描述的角色切换场景
- 实现真实的外部文件读写操作
- 测试完整的记忆管理流程

### 2. **全面的能力评估**
- 覆盖角色切换的所有关键维度
- 评估记忆管理的各个方面
- 测试状态连续性的多个层次

### 3. **实用的测试设计**
- 使用真实的文件操作
- 模拟实际的工作场景
- 提供详细的分析报告

## 🔮 预期挑战

### 主要技术挑战
1. **上下文长度限制**: 多源信息可能导致上下文过长
2. **角色混淆**: 频繁切换可能导致角色特征混乱
3. **记忆一致性**: 保持记忆文件的逻辑一致性
4. **信息优先级**: 处理提示词与记忆文件的冲突

### 解决策略
1. **分层信息管理**: 将信息按重要性分层处理
2. **角色隔离机制**: 确保角色间的清晰边界
3. **记忆验证**: 实现记忆更新的逻辑验证
4. **冲突解决**: 设计明确的信息优先级规则

## 📈 成功标准

### 优秀表现 (≥80%)
- 角色切换成功率 ≥90%
- 记忆持续性评分 ≥80%
- 注意力焦点准确性 ≥70%
- 无跨角色信息泄露

### 良好表现 (60-80%)
- 角色切换成功率 ≥70%
- 记忆持续性评分 ≥60%
- 注意力焦点准确性 ≥50%
- 轻微跨角色干扰

### 需要改进 (<60%)
- 角色切换频繁失败
- 记忆管理混乱
- 注意力焦点模糊
- 严重的角色混淆

## 🎯 总结

**您的场景需求现有测试无法完全支持**，但我已经创建了专门的 **Pillar 21: 动态角色切换与记忆管理测试**，完全针对您描述的能力需求设计。

这个测试方案不仅能够评估模型的动态角色切换能力，还能深入测试外部记忆文件管理、状态连续性维护等关键能力，为您提供全面而准确的能力评估。
